%%% this function is a matlab implementation of a similar R program
%%% generally speaking the R code is more up-to-date

% main function for evaluation
function wave_eval(base_dir, test_dir, output_dir)

    % import the data and output formant metrics to output dir
    computer = wave_compute();
    test_output = computer.compute(test_dir);
    base_output = computer.compute(base_dir);

    % just a bit of output to show that it's working
    for i = 1:size(test_output,2)
        fprintf("Sample %i: \n" + ...
                "Mean F1 Test: %4.2f \n" + ...
                "Mean F1 Base: %4.2f \n" + ...
                "Mean F2 Test: %4.2f \n" + ...
                "Mean F2 Base: %4.2f \n", ...
                i, ...
                test_output(i).f1_mean, ...
                base_output(i).f1_mean, ...
                test_output(i).f2_mean, ...
                base_output(i).f2_mean);
    end

    % create a comparison struct with relevant comparisons
    f0_mean_corr = corrcoef(extractfield(base_output, 'f0_mean'), extractfield(test_output, 'f0_mean'), 'Rows', 'complete');
    f1_mean_corr = corrcoef(extractfield(base_output, 'f1_mean'), extractfield(test_output, 'f1_mean'), 'Rows', 'complete');
    f2_mean_corr = corrcoef(extractfield(base_output, 'f2_mean'), extractfield(test_output, 'f2_mean'), 'Rows', 'complete');
    f0_median_corr = corrcoef(extractfield(base_output, 'f0_median'), extractfield(test_output, 'f0_median'), 'Rows', 'complete');
    f1_median_corr = corrcoef(extractfield(base_output, 'f1_median'), extractfield(test_output, 'f1_median'), 'Rows', 'complete');
    f2_median_corr = corrcoef(extractfield(base_output, 'f2_median'), extractfield(test_output, 'f2_median'), 'Rows', 'complete');
    comparison = struct('f0_mean_corr', f0_mean_corr(1,2), ...
                        'f1_mean_corr', f1_mean_corr(1,2), ...
                        'f2_mean_corr', f2_mean_corr(1,2), ...
                        'f0_abs_mean_diff', mean(abs(extractfield(base_output, 'f0_mean') - extractfield(test_output, 'f0_mean')), "omitnan"), ...
                        'f1_abs_mean_diff', mean(abs(extractfield(base_output, 'f1_mean') - extractfield(test_output, 'f1_mean')), "omitnan"), ...
                        'f2_abs_mean_diff', mean(abs(extractfield(base_output, 'f2_mean') - extractfield(test_output, 'f2_mean')), "omitnan"), ...
                        'f0_mean_diff', mean(extractfield(base_output, 'f0_mean') - extractfield(test_output, 'f0_mean'), "omitnan"), ...
                        'f1_mean_diff', mean(extractfield(base_output, 'f1_mean') - extractfield(test_output, 'f1_mean'), "omitnan"), ...
                        'f2_mean_diff', mean(extractfield(base_output, 'f2_mean') - extractfield(test_output, 'f2_mean'), "omitnan"), ...
                        'f0_median_corr', f0_median_corr(1,2), ...
                        'f1_median_corr', f1_median_corr(1,2), ...
                        'f2_median_corr', f2_median_corr(1,2), ...
                        'f0_abs_median_diff', mean(abs(extractfield(base_output, 'f0_median') - extractfield(test_output, 'f0_median')), "omitnan"), ...
                        'f1_abs_median_diff', mean(abs(extractfield(base_output, 'f1_median') - extractfield(test_output, 'f1_median')), "omitnan"), ...
                        'f2_abs_median_diff', mean(abs(extractfield(base_output, 'f2_median') - extractfield(test_output, 'f2_median')), "omitnan"), ...
                        'f0_median_diff', mean(extractfield(base_output, 'f0_median') - extractfield(test_output, 'f0_median'), "omitnan"), ...
                        'f1_median_diff', mean(extractfield(base_output, 'f1_median') - extractfield(test_output, 'f1_median'), "omitnan"), ...
                        'f2_median_diff', mean(extractfield(base_output, 'f2_median') - extractfield(test_output, 'f2_median'), "omitnan"), ...
                        'f0_mean_diff_dist', extractfield(base_output, 'f0_mean') - extractfield(test_output, 'f0_mean'), ...
                        'f0_median_diff_dist', extractfield(base_output, 'f0_median') - extractfield(test_output, 'f0_median'), ...
                        'f1_mean_diff_dist', extractfield(base_output, 'f1_mean') - extractfield(test_output, 'f1_mean'), ...
                        'f1_median_diff_dist', extractfield(base_output, 'f1_median') - extractfield(test_output, 'f1_median'), ...
                        'f2_mean_diff_dist', extractfield(base_output, 'f2_mean') - extractfield(test_output, 'f2_mean'), ...
                        'f2_median_diff_dist', extractfield(base_output, 'f2_median') - extractfield(test_output, 'f2_median') ...
                        );
    
    % save files and printout to show that the function is finished
    save(fullfile(output_dir, "test_output.mat"), "test_output");
    save(fullfile(output_dir, "base_output.mat"), "base_output");
    save(fullfile(output_dir,"base_vs_test_comparison.mat"), "comparison");
    fprintf("Evaluation Successful!\n");
end
