
% main function for evaluation
function wave_eval(base_dir, test_dir, output_dir)

    % import the data and output formant metrics to output dir
    test_output = compute(test_dir);
    base_output = compute(base_dir);

    % just a bit of output to show that it's working
    for i = 1:size(test_output,2)
        fprintf("Sample %i: \n" + ...
                "Mean F1 Test: %4.2f \n" + ...
                "Mean F1 Base: %4.2f \n" + ...
                "Mean F2 Test: %4.2f \n" + ...
                "Mean F2 Base: %4.2f \n", ...
                i, ...
                test_output(i).f1_mean, ...
                base_output(i).f1_mean, ...
                test_output(i).f2_mean, ...
                base_output(i).f2_mean);
    end

    % create a comparison struct with relevant comparisons
    f0_mean_corr = corrcoef(extractfield(base_output, 'f0_mean'), extractfield(test_output, 'f0_mean'), 'Rows', 'complete');
    f1_mean_corr = corrcoef(extractfield(base_output, 'f1_mean'), extractfield(test_output, 'f1_mean'), 'Rows', 'complete');
    f2_mean_corr = corrcoef(extractfield(base_output, 'f2_mean'), extractfield(test_output, 'f2_mean'), 'Rows', 'complete');
    f0_median_corr = corrcoef(extractfield(base_output, 'f0_median'), extractfield(test_output, 'f0_median'), 'Rows', 'complete');
    f1_median_corr = corrcoef(extractfield(base_output, 'f1_median'), extractfield(test_output, 'f1_median'), 'Rows', 'complete');
    f2_median_corr = corrcoef(extractfield(base_output, 'f2_median'), extractfield(test_output, 'f2_median'), 'Rows', 'complete');
    comparison = struct('f0_mean_corr', f0_mean_corr(1,2), ...
                        'f1_mean_corr', f1_mean_corr(1,2), ...
                        'f2_mean_corr', f2_mean_corr(1,2), ...
                        'f0_abs_mean_diff', mean(abs(extractfield(base_output, 'f0_mean') - extractfield(test_output, 'f0_mean')), "omitnan"), ...
                        'f1_abs_mean_diff', mean(abs(extractfield(base_output, 'f1_mean') - extractfield(test_output, 'f1_mean')), "omitnan"), ...
                        'f2_abs_mean_diff', mean(abs(extractfield(base_output, 'f2_mean') - extractfield(test_output, 'f2_mean')), "omitnan"), ...
                        'f0_mean_diff', mean(extractfield(base_output, 'f0_mean') - extractfield(test_output, 'f0_mean'), "omitnan"), ...
                        'f1_mean_diff', mean(extractfield(base_output, 'f1_mean') - extractfield(test_output, 'f1_mean'), "omitnan"), ...
                        'f2_mean_diff', mean(extractfield(base_output, 'f2_mean') - extractfield(test_output, 'f2_mean'), "omitnan"), ...
                        'f0_median_corr', f0_median_corr(1,2), ...
                        'f1_median_corr', f1_median_corr(1,2), ...
                        'f2_median_corr', f2_median_corr(1,2), ...
                        'f0_abs_median_diff', mean(abs(extractfield(base_output, 'f0_median') - extractfield(test_output, 'f0_median')), "omitnan"), ...
                        'f1_abs_median_diff', mean(abs(extractfield(base_output, 'f1_median') - extractfield(test_output, 'f1_median')), "omitnan"), ...
                        'f2_abs_median_diff', mean(abs(extractfield(base_output, 'f2_median') - extractfield(test_output, 'f2_median')), "omitnan"), ...
                        'f0_median_diff', mean(extractfield(base_output, 'f0_median') - extractfield(test_output, 'f0_median'), "omitnan"), ...
                        'f1_median_diff', mean(extractfield(base_output, 'f1_median') - extractfield(test_output, 'f1_median'), "omitnan"), ...
                        'f2_median_diff', mean(extractfield(base_output, 'f2_median') - extractfield(test_output, 'f2_median'), "omitnan"));
    
    % save files and printout to show that the function is finished
    save(fullfile(output_dir, "test_output.mat"), "test_output");
    save(fullfile(output_dir, "base_output.mat"), "base_output");
    save(fullfile(output_dir,"base_vs_test_comparison.mat"), "comparison");
    fprintf("Evaluation Successful!\n");
end

% function that imports information from a dataVals matrix
function output = compute(directory)
    datavals_path = fullfile(directory, "dataVals.mat");
    try
        datavals = importdata(datavals_path).dataVals;
    catch ME
        % accounts for the 2 ways dataVals can be stored
        if (strcmp(ME.identifier, 'MATLAB:nonExistentField'))
            datavals = importdata(datavals_path);
        else
            disp("ERROR: Could not extract dataVals from directory.")
            disp(datavals_path);
            disp(ME);
        end
    end
    for i = size(datavals,2):-1:1
        if isempty(datavals(i).f0)
            output(i) = struct('f0_median', NaN, ...
                               'f0_mean', NaN, ...
                               'f0_start', NaN, ...
                               'f0_end', NaN, ...
                               'f1_median', NaN, ...
                               'f1_mean', NaN, ...
                               'f1_start', NaN, ...
                               'f1_end', NaN, ...
                               'f2_median', NaN, ...
                               'f2_mean', NaN, ...
                               'f2_start', NaN, ...
                               'f2_end', NaN, ...
                               'int_median', NaN, ...
                               'int_mean', NaN, ...
                               'int_start', NaN, ...
                               'int_end', NaN, ...
                               'f_onset', NaN, ...
                               'f_offset', NaN, ...
                               'pitch_onset', NaN, ...
                               'pitch_offset', NaN, ...
                               'ampl_onset', NaN, ...
                               'ampl_offset', NaN, ...
                               'dur', NaN);
            continue
        end
        output(i) = struct('f0_median', median(datavals(i).f0, "omitnan"), ...
                           'f0_mean', mean(datavals(i).f0, "omitnan"), ...
                           'f0_start', datavals(i).f0(2), ...
                           'f0_end', datavals(i).f0(end-1), ...
                           'f1_median', median(datavals(i).f1, "omitnan"), ...
                           'f1_mean', mean(datavals(i).f1, "omitnan"), ...
                           'f1_start', datavals(i).f1(2), ...
                           'f1_end', datavals(i).f1(end-1), ...
                           'f2_median', median(datavals(i).f2, "omitnan"), ...
                           'f2_mean', mean(datavals(i).f2, "omitnan"), ...
                           'f2_start', datavals(i).f2(2), ...
                           'f2_end', datavals(i).f2(end-1), ...
                           'int_median', median(datavals(i).int, "omitnan"), ...
                           'int_mean', mean(datavals(i).int, "omitnan"), ...
                           'int_start', datavals(i).int(2), ...
                           'int_end', datavals(i).int(end-1), ...
                           'f_onset', datavals(i).ftrack_taxis(2), ...
                           'f_offset', datavals(i).ftrack_taxis(end-1), ...
                           'pitch_onset', datavals(i).pitch_taxis(2), ...
                           'pitch_offset', datavals(i).pitch_taxis(end-1), ...
                           'ampl_onset', datavals(i).ampl_taxis(2), ...
                           'ampl_offset', datavals(i).ampl_taxis(end-1), ...
                           'dur', datavals(i).dur);
    end
end
